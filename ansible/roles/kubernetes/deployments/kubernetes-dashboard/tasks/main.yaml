---

- name: Set if present or absent
  set_fact:
    state: present

- name: "Add Helm repository: kubernetes-dashboard"
  kubernetes.core.helm_repository:
      name: kubernetes-dashboard
      repo_url: https://kubernetes.github.io/dashboard/

- name: Read values.yaml
  set_fact:
    values: "{{lookup('ansible.builtin.file', './values.yaml') | from_yaml }}"

- name: Read ingress.yaml
  set_fact:
    ingress: "{{lookup('ansible.builtin.file', './ingress.yaml') | from_yaml }}"

- name: "Create namespace: kubernetes-dashboard"
  k8s:
    name: kubernetes-dashboard
    kind: Namespace
    state: "{{ state }}"

- name: Install kubernetes-dashboard
  kubernetes.core.helm:
    name: kubernetes-dashboard
    namespace: kubernetes-dashboard
    chart_ref: kubernetes-dashboard/kubernetes-dashboard
    release_values: "{{ values }}"
    state: "{{ state }}"
  register: result

- name: Helm chart result
  debug:
    msg: "{{ result.stdout_lines }}"

- name: Read service_account.yaml
  set_fact:
    service_account: "{{lookup('ansible.builtin.file', './service-account.yaml') | from_yaml }}"

- name: Read custer_role_binding.yaml
  set_fact:
    custer_role_binding: "{{lookup('ansible.builtin.file', './cluster-role-binding.yaml') | from_yaml }}"

- name: Deploy service account for dashboard admin
  k8s:
    state: "{{ state }}"
    definition: "{{ service_account }}"

- name: Deploy cluster role binding for dashboard admin
  k8s:
    state: "{{ state }}"
    definition: "{{ custer_role_binding }}"

- name: Deploy ingress
  k8s:
    state: "{{ state }}"
    definition: "{{ ingress }}"
